{% load static %}
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Checkout - Bolis Naturales</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}" />
  </head>

  <body>
    <div class="container">
      <header class="header">
        <h1 class="titulo-marca">Checkout</h1>
        <nav class="nav">
          <a href="{% url 'catalogo' %}">Seguir comprando</a>
          <a href="{% url 'cart_detail' %}">Carrito</a>
        </nav>
      </header>

      <main style="padding: 16px">
        <!-- DEBUG visual (opcional) -->
        <!-- prettier-ignore -->
        <p style="opacity: 0.7; font-size: 14px">
  Items: {{ items|length }} ‚Äî Subtotal: ${{ subtotal }} ‚Äî Env√≠o: ${{ envio }} ‚Äî Total: ${{ total }}
</p>

        {% if error %}
        <p style="font-weight: 800; color: #b91c1c">{{ error }}</p>
        {% endif %}

        <h2>Tu pedido</h2>

        {% if items %}
        <div class="breakfast-grid" style="grid-template-columns: 1fr">
          {% for it in items %}
          <article>
            <h3>{{ it.producto.nombre }}</h3>
            <p>Cantidad: <strong>{{ it.qty }}</strong></p>
            <p>Subtotal: <strong>${{ it.subtotal }}</strong></p>
          </article>
          {% endfor %}
        </div>

        <hr />

        <p><strong>Subtotal:</strong> ${{ subtotal }}</p>
        <p><strong>Env√≠o:</strong> ${{ envio }} (costo adicional)</p>
        <p><strong>Total:</strong> ${{ total }}</p>

        <!-- üöö Mensaje para subir ticket (din√°mico) -->
        {% if mensaje_envio %}
        <p style="font-weight: 800; color: #16a34a; margin-top: 10px">
          {{ mensaje_envio }}
        </p>
        {% endif %}

        <hr />

        <h2>Horario de reparto</h2>
        <p>
          <strong>Horarios:</strong><br />
          {{ horarios.lv }}<br />
          {{ horarios.sd }}
        </p>

        <!-- ===================== -->
        <!-- FORMULARIO -->
        <!-- ===================== -->
        <form method="post">
          {% csrf_token %}

          <label>Nombre</label><br />
          <input name="nombre" required class="form-input" />

          <label>Tel√©fono</label><br />
          <input
            name="telefono"
            required
            class="form-input"
            inputmode="numeric"
            maxlength="14"
            id="telefono"
            placeholder="(209) 555-1234"
            autocomplete="tel"
          />

          <label>Direcci√≥n de env√≠o</label><br />
          <input
            name="direccion"
            required
            class="form-input"
            autocomplete="street-address"
          />

          <label>Mensaje (opcional)</label><br />
          <textarea name="mensaje" rows="3" class="form-input"></textarea>

          <button
            type="submit"
            class="btn btn-primary btn-cta"
            style="margin-top: 12px"
          >
            Confirmar pedido
          </button>
        </form>

        {% else %}
        <p>No hay productos en tu carrito.</p>
        <a href="{% url 'catalogo' %}" class="btn">Volver al cat√°logo</a>
        {% endif %}
      </main>
    </div>

    <!-- ===================== -->
    <!-- JS: Tel√©fono solo n√∫meros + formato (###) ###-#### -->
    <!-- ===================== -->
    <script>
      const telInput = document.getElementById("telefono");

      if (telInput) {
        telInput.addEventListener("input", function (e) {
          // 1) Quitar todo lo que no sea n√∫mero
          let numbers = e.target.value.replace(/\D/g, "");

          // 2) Limitar a 10 d√≠gitos (USA)
          numbers = numbers.substring(0, 10);

          // 3) Formatear (###) ###-####
          let formatted = "";

          if (numbers.length === 0) {
            formatted = "";
          } else if (numbers.length < 4) {
            formatted = `(${numbers}`;
          } else if (numbers.length < 7) {
            formatted = `(${numbers.slice(0, 3)}) ${numbers.slice(3)}`;
          } else {
            formatted = `(${numbers.slice(0, 3)}) ${numbers.slice(3, 6)}-${numbers.slice(6)}`;
          }

          e.target.value = formatted;
        });
      }
    </script>
  </body>
</html>
